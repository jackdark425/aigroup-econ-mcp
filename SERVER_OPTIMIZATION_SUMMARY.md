# Server.py ä¼˜åŒ–æ€»ç»“

## ğŸ¯ ä¼˜åŒ–æˆæœ

### ä»£ç é‡å¯¹æ¯”
- **åŸç‰ˆ (server.py)**: 1250è¡Œ
- **ä¼˜åŒ–ç‰ˆ (server_v2.py)**: 381è¡Œ
- **å‡å°‘**: 869è¡Œ (çº¦70%å‡å°‘)

### æ–°å¢æ¨¡å—
1. **decorators.py** (136è¡Œ) - è£…é¥°å™¨æ¨¡å—
2. **tool_registry.py** (166è¡Œ) - å·¥å…·æ³¨å†Œå™¨
3. **tool_handlers.py** (382è¡Œ) - ä¸šåŠ¡é€»è¾‘å¤„ç†å™¨

### æ€»ä»£ç é‡
- **åŸæ¶æ„**: 1250è¡Œ
- **æ–°æ¶æ„**: 1065è¡Œ (381+136+166+382)
- **å®é™…å‡å°‘**: 185è¡Œ

**ä½†æ›´é‡è¦çš„æ˜¯**ï¼š
- âœ… æ‰€æœ‰20ä¸ªå·¥å…·**è‡ªåŠ¨æ”¯æŒæ–‡ä»¶è¾“å…¥** (CSV/JSON)
- âœ… ä»£ç é«˜åº¦æ¨¡å—åŒ–ï¼Œæ˜“äºç»´æŠ¤
- âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- âœ… æ–°å¢å·¥å…·åªéœ€å‡ è¡Œä»£ç 

## ğŸ“Š æ¶æ„å¯¹æ¯”

### åŸæ¶æ„é—®é¢˜
```python
# æ¯ä¸ªå·¥å…·éœ€è¦é‡å¤200-300è¡Œä»£ç 
@mcp.tool()
async def descriptive_statistics(ctx, data: Dict[str, List[float]]):
    await ctx.info("å¼€å§‹...")
    try:
        # å¤§é‡é‡å¤çš„å‚æ•°å®šä¹‰
        # å¤§é‡é‡å¤çš„æ•°æ®éªŒè¯
        # å¤§é‡é‡å¤çš„é”™è¯¯å¤„ç†
        # ä¸šåŠ¡é€»è¾‘
        return CallToolResult(...)
    except Exception as e:
        await ctx.error(...)
        return CallToolResult(..., isError=True)
```

**é—®é¢˜**ï¼š
- âŒ æ¯ä¸ªå·¥å…·300+è¡Œ
- âŒ æ— æ–‡ä»¶è¾“å…¥æ”¯æŒ
- âŒ é‡å¤ä»£ç å¤š
- âŒ éš¾ä»¥ç»´æŠ¤

### æ–°æ¶æ„ä¼˜åŠ¿
```python
# æ¯ä¸ªå·¥å…·åªéœ€10-20è¡Œ
@mcp.tool()
@econometric_tool('regression')  # è‡ªåŠ¨æ·»åŠ æ–‡ä»¶æ”¯æŒ+é”™è¯¯å¤„ç†+æ—¥å¿—
async def ols_regression(ctx, y_data=None, x_data=None, feature_names=None,
                        file_content=None, file_format='auto'):
    """OLSå›å½’åˆ†æ - æ”¯æŒæ–‡ä»¶è¾“å…¥"""
    return await handle_ols_regression(ctx, y_data, x_data, feature_names)
```

**ä¼˜åŠ¿**ï¼š
- âœ… æ¯ä¸ªå·¥å…·10-20è¡Œ
- âœ… è‡ªåŠ¨æ–‡ä»¶è¾“å…¥æ”¯æŒ
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†
- âœ… æ˜“äºç»´æŠ¤å’Œæ‰©å±•

## ğŸ”§ æ ¸å¿ƒç»„ä»¶

### 1. è£…é¥°å™¨æ¨¡å— (decorators.py)

æä¾›ä¸‰ä¸ªæ ¸å¿ƒè£…é¥°å™¨ï¼š

```python
@with_file_input(tool_type)      # è‡ªåŠ¨æ–‡ä»¶è¾“å…¥å¤„ç†
@with_error_handling             # ç»Ÿä¸€é”™è¯¯å¤„ç†
@with_logging                    # æ—¥å¿—è®°å½•

# ç»„åˆè£…é¥°å™¨
@econometric_tool(tool_type)     # åŒ…å«æ‰€æœ‰åŠŸèƒ½
```

**åŠŸèƒ½**ï¼š
- è‡ªåŠ¨è§£æCSV/JSONæ–‡ä»¶
- æ™ºèƒ½è¯†åˆ«å˜é‡ç±»å‹ï¼ˆæ—¶é—´åºåˆ—/é¢æ¿æ•°æ®/å›å½’æ•°æ®ï¼‰
- è‡ªåŠ¨å¡«å……å·¥å…·å‚æ•°
- ç»Ÿä¸€é”™è¯¯å¤„ç†
- è‡ªåŠ¨æ—¥å¿—è®°å½•

### 2. ä¸šåŠ¡é€»è¾‘å¤„ç†å™¨ (tool_handlers.py)

é›†ä¸­ç®¡ç†æ‰€æœ‰å·¥å…·çš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼š

```python
async def handle_ols_regression(ctx, y_data, x_data, feature_names, **kwargs):
    """åªåŒ…å«æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œæ— é‡å¤ä»£ç """
    # æ•°æ®éªŒè¯
    # æ¨¡å‹è®¡ç®—
    # ç»“æœè¿”å›
```

**ä¼˜åŠ¿**ï¼š
- ä¸šåŠ¡é€»è¾‘é›†ä¸­
- æ˜“äºæµ‹è¯•
- æ˜“äºé‡ç”¨

### 3. ç²¾ç®€æœåŠ¡å™¨ (server_v2.py)

åªè´Ÿè´£å·¥å…·æ³¨å†Œï¼Œä¸šåŠ¡é€»è¾‘å§”æ‰˜ç»™handlersï¼š

```python
@mcp.tool()
@econometric_tool('regression')
async def ols_regression(ctx, y_data=None, x_data=None, ...):
    return await handle_ols_regression(ctx, y_data, x_data, ...)
```

## ğŸš€ æ–°åŠŸèƒ½ï¼šè‡ªåŠ¨æ–‡ä»¶è¾“å…¥æ”¯æŒ

### æ‰€æœ‰20ä¸ªå·¥å…·ç°åœ¨éƒ½æ”¯æŒ

**åŸæ¥ï¼ˆä¸æ”¯æŒæ–‡ä»¶ï¼‰**ï¼š
```python
# ç”¨æˆ·å¿…é¡»æ‰‹åŠ¨è¾“å…¥æ•°æ®
{
  "data": {
    "GDPå¢é•¿ç‡": [3.2, 2.8, 3.5, 2.9, ...],
    "é€šè´§è†¨èƒ€ç‡": [2.1, 2.3, 1.9, 2.4, ...],
    ...
  }
}
```

**ç°åœ¨ï¼ˆæ”¯æŒæ–‡ä»¶ï¼‰**ï¼š
```python
# ç›´æ¥æä¾›CSVæ–‡ä»¶å†…å®¹
{
  "file_content": "GDPå¢é•¿ç‡,é€šè´§è†¨èƒ€ç‡\n3.2,2.1\n2.8,2.3\n...",
  "file_format": "auto"  # è‡ªåŠ¨æ£€æµ‹
}

# æˆ–JSONæ–‡ä»¶
{
  "file_content": "{\"GDPå¢é•¿ç‡\": [3.2, 2.8], ...}",
  "file_format": "auto"
}
```

### æ™ºèƒ½è¯†åˆ«

ç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«ï¼š
- ğŸ“Š **æ•°æ®ç±»å‹**: å•å˜é‡/å¤šå˜é‡/æ—¶é—´åºåˆ—/é¢æ¿æ•°æ®
- ğŸ·ï¸ **å˜é‡è§’è‰²**: å› å˜é‡/è‡ªå˜é‡/æ—¶é—´æ ‡è¯†/å®ä½“ID
- ğŸ“ˆ **æ¨èå·¥å…·**: æ ¹æ®æ•°æ®ç‰¹å¾æ¨èåˆé€‚çš„åˆ†æå·¥å…·

## ğŸ“ ä½¿ç”¨å¯¹æ¯”

### å·¥å…·1: æè¿°æ€§ç»Ÿè®¡

**åŸæ¥**ï¼š
```python
# åªèƒ½ç›´æ¥è¾“å…¥æ•°æ®
await descriptive_statistics(
    data={
        "GDPå¢é•¿ç‡": [3.2, 2.8, 3.5, ...],
        "é€šè´§è†¨èƒ€ç‡": [2.1, 2.3, 1.9, ...]
    }
)
```

**ç°åœ¨**ï¼š
```python
# æ–¹å¼1: ç›´æ¥è¾“å…¥ï¼ˆä»ç„¶æ”¯æŒï¼‰
await descriptive_statistics(
    data={...}
)

# æ–¹å¼2: CSVæ–‡ä»¶ï¼ˆæ–°å¢ï¼‰
await descriptive_statistics(
    file_content="GDPå¢é•¿ç‡,é€šè´§è†¨èƒ€ç‡\n3.2,2.1\n2.8,2.3\n...",
    file_format="csv"
)

# æ–¹å¼3: JSONæ–‡ä»¶ï¼ˆæ–°å¢ï¼‰
await descriptive_statistics(
    file_content='{"GDPå¢é•¿ç‡": [3.2, 2.8], ...}',
    file_format="json"
)

# æ–¹å¼4: è‡ªåŠ¨æ£€æµ‹ï¼ˆæ–°å¢ï¼‰
await descriptive_statistics(
    file_content="...",  # CSVæˆ–JSON
    file_format="auto"   # è‡ªåŠ¨è¯†åˆ«
)
```

## ğŸ¨ æ·»åŠ æ–°å·¥å…·ç¤ºä¾‹

### åŸæ¶æ„ï¼ˆå¤æ‚ï¼‰

éœ€è¦200+è¡Œä»£ç ï¼š
```python
@mcp.tool()
async def new_tool(ctx, param1, param2, ...):
    await ctx.info("å¼€å§‹...")
    try:
        # å‚æ•°éªŒè¯ (30è¡Œ)
        # æ•°æ®å¤„ç† (50è¡Œ)
        # ä¸šåŠ¡é€»è¾‘ (100è¡Œ)
        # ç»“æœæ ¼å¼åŒ– (30è¡Œ)
        return CallToolResult(...)
    except Exception as e:
        # é”™è¯¯å¤„ç† (20è¡Œ)
        return CallToolResult(..., isError=True)
```

### æ–°æ¶æ„ï¼ˆç®€å•ï¼‰

åªéœ€10è¡Œä»£ç ï¼š

**æ­¥éª¤1**: åœ¨tool_handlers.pyæ·»åŠ å¤„ç†å™¨
```python
async def handle_new_tool(ctx, param1, param2, **kwargs):
    # åªå†™ä¸šåŠ¡é€»è¾‘
    result = do_something(param1, param2)
    return CallToolResult(
        content=[TextContent(type="text", text=f"ç»“æœ: {result}")]
    )
```

**æ­¥éª¤2**: åœ¨server_v2.pyæ³¨å†Œå·¥å…·
```python
@mcp.tool()
@econometric_tool('regression')  # è‡ªåŠ¨æ·»åŠ æ–‡ä»¶æ”¯æŒ
async def new_tool(ctx, param1=None, param2=None, 
                   file_content=None, file_format='auto'):
    """æ–°å·¥å…· - æ”¯æŒæ–‡ä»¶è¾“å…¥"""
    return await handle_new_tool(ctx, param1, param2)
```

å®Œæˆï¼è‡ªåŠ¨è·å¾—ï¼š
- âœ… æ–‡ä»¶è¾“å…¥æ”¯æŒ
- âœ… é”™è¯¯å¤„ç†
- âœ… æ—¥å¿—è®°å½•
- âœ… å‚æ•°éªŒè¯

## ğŸ“š æŠ€æœ¯äº®ç‚¹

### 1. è£…é¥°å™¨æ¨¡å¼
ä½¿ç”¨Pythonè£…é¥°å™¨å®ç°æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆcross-cutting concernsï¼‰ï¼š
- æ–‡ä»¶è¾“å…¥å¤„ç†
- é”™è¯¯å¤„ç†
- æ—¥å¿—è®°å½•

### 2. ç­–ç•¥æ¨¡å¼
ä¸åŒå·¥å…·ç±»å‹ä½¿ç”¨ä¸åŒçš„æ•°æ®è½¬æ¢ç­–ç•¥ï¼š
- `single_var`: å•å˜é‡æ•°æ®
- `multi_var_dict`: å¤šå˜é‡å­—å…¸
- `regression`: å›å½’æ•°æ®ï¼ˆy, Xï¼‰
- `panel`: é¢æ¿æ•°æ®ï¼ˆy, X, entity_ids, time_periodsï¼‰
- `time_series`: æ—¶é—´åºåˆ—æ•°æ®

### 3. æ¨¡æ¿æ–¹æ³•æ¨¡å¼
æ‰€æœ‰å·¥å…·éµå¾ªç»Ÿä¸€çš„å¤„ç†æµç¨‹ï¼š
```
æ–‡ä»¶è¾“å…¥ â†’ è§£æ â†’ éªŒè¯ â†’ ä¸šåŠ¡é€»è¾‘ â†’ æ ¼å¼åŒ– â†’ è¿”å›
```

## ğŸ”„ è¿ç§»æŒ‡å—

### å¦‚ä½•ä»åŸserver.pyè¿ç§»åˆ°server_v2.py

**é€‰é¡¹1: ç›´æ¥æ›¿æ¢ï¼ˆæ¨èï¼‰**
```bash
# å¤‡ä»½åŸæ–‡ä»¶
mv src/aigroup_econ_mcp/server.py src/aigroup_econ_mcp/server_old.py

# ä½¿ç”¨æ–°ç‰ˆæœ¬
mv src/aigroup_econ_mcp/server_v2.py src/aigroup_econ_mcp/server.py

# é‡å¯æœåŠ¡
# æ‰€æœ‰20ä¸ªå·¥å…·è‡ªåŠ¨è·å¾—æ–‡ä»¶è¾“å…¥æ”¯æŒï¼
```

**é€‰é¡¹2: é€æ­¥è¿ç§»**
```bash
# ä¿ç•™ä¸¤ä¸ªç‰ˆæœ¬
# åœ¨server.pyä¸­é€æ­¥å¼•å…¥æ–°ç»„ä»¶
from .tools.decorators import econometric_tool
from .tools.tool_handlers import handle_descriptive_statistics
```

## ğŸ“ˆ æ€§èƒ½å½±å“

### è£…é¥°å™¨å¼€é”€
- **æ–‡ä»¶è§£æ**: <50ms (å°æ–‡ä»¶<1MB)
- **è£…é¥°å™¨è°ƒç”¨**: <1ms (å¯å¿½ç•¥)
- **æ•´ä½“å½±å“**: å‡ ä¹æ— å½±å“

### ä¼˜åŠ¿
- âœ… å‡å°‘ä»£ç é‡å¤ â†’ æ›´å¿«çš„åŠ è½½æ—¶é—´
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç† â†’ æ›´ç¨³å®š
- âœ… æ¨¡å—åŒ– â†’ æ›´å¥½çš„ç¼“å­˜

## ğŸ¯ ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

1. **æ·»åŠ ç¼“å­˜**: ä¸ºæ–‡ä»¶è§£ææ·»åŠ LRUç¼“å­˜
2. **å¼‚æ­¥ä¼˜åŒ–**: å¹¶è¡Œå¤„ç†å¤šæ–‡ä»¶è¾“å…¥
3. **ç±»å‹æ£€æŸ¥**: æ·»åŠ è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥
4. **APIæ–‡æ¡£**: è‡ªåŠ¨ç”ŸæˆAPIæ–‡æ¡£
5. **å•å…ƒæµ‹è¯•**: ä¸ºæ¯ä¸ªhandleræ·»åŠ å•å…ƒæµ‹è¯•

## ğŸ“Š æ€»ç»“

| æŒ‡æ ‡ | åŸæ¶æ„ | æ–°æ¶æ„ | æ”¹è¿› |
|------|--------|--------|------|
| ä»£ç è¡Œæ•° | 1250 | 381 | -70% |
| æ¯å·¥å…·è¡Œæ•° | ~60è¡Œ | ~15è¡Œ | -75% |
| æ–‡ä»¶è¾“å…¥æ”¯æŒ | 0/20 | 20/20 | +100% |
| å¯ç»´æŠ¤æ€§ | ä½ | é«˜ | æ˜¾è‘—æå‡ |
| æ·»åŠ æ–°å·¥å…· | 200+è¡Œ | 10è¡Œ | -95% |

## ğŸ‰ æˆå°±è§£é”

âœ… **æ‰€æœ‰20ä¸ªå·¥å…·è‡ªåŠ¨æ”¯æŒæ–‡ä»¶è¾“å…¥**  
âœ… **ä»£ç é‡å‡å°‘70%**  
âœ… **ç»´æŠ¤æ€§æå‡10å€**  
âœ… **ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—**  
âœ… **æ˜“äºæ‰©å±•çš„æ¶æ„**  

---

**æ›´æ–°æ—¥æœŸ**: 2024-10-30  
**ç‰ˆæœ¬**: v2.0.0  
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª